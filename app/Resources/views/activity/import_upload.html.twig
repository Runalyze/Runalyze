{% extends "activity/import_base.html.twig" %}

{% block content %}
<div id="upload-container">
    <div class="c button" id="file-upload">{% trans %}Upload file{% endtrans %}</div>
</div>

<script>
    var submittedFiles = [], completedFiles = 0, uploadedFiles = 0;

    new qq.FineUploaderBasic({
        button: $("#file-upload")[0],
        request: {
            endpoint: "{{ url('internal-activity-upload') }}"
        },
        validation: {
            //allowedExtensions: [<?php echo "'".implode("', '", $this->Filetypes)."'"; ?>]
        },
        callbacks: {
            onError: function(id, name, errorReason, xhr) {
                $("#ajax").append('<p class="error appended-by-uploader">'+name+': '+errorReason+'</p>');
            },
            onSubmit: function(id, fileName) {
                submittedFiles.push(fileName.replace(/;/g, '_-_'));
                $("#upload-container").addClass('loading');
            },
            onComplete: function(id, fileName, responseJSON) {
                uploadedFiles++;

                if (responseJSON.success) {
                    completedFiles++;

                    if (completedFiles == submittedFiles.length) {
                        $(".appended-by-uploader").remove();

                        if (completedFiles == 1) {
                            $("#ajax").loadDiv('{{ url('activity-upload') }}?file='+encodeURIComponent(submittedFiles[0]));
                        } else {
                            $("#ajax").loadDiv('{{ url('activity-upload') }}?files='+encodeURIComponent(submittedFiles.join(';')));
                        }
                    }
                } else {
                    $("#ajax").append('<p class="error appended-by-uploader">{% trans %}There were problems while uploading.{% endtrans %}</p>');
                }

                if (uploadedFiles == submittedFiles.length) {
                    $("#upload-container").removeClass('loading');

                    submittedFiles = [];
                    completedFiles = 0;
                    uploadedFiles = 0;
                }
            }
        }
    });

    if (!qq.supportedFeatures.ajaxUploading)
        $("#ajax").append('<p class="error">{% trans %}Your browser does not seem to support this uploader, see{% endtrans %}<a href="http://docs.fineuploader.com/browser-support.html" target="_blank">http://docs.fineuploader.com/browser-support.html</a>.</p>');
</script>

<p class="text">
    &nbsp;
</p>

<p class="info">
    <a href="http://help.runalyze.com/latest/starting-guide/import.html#different-file-types" target="_blank">{% trans %}Supported file extensions{% endtrans %}</a>
    ...
</p>

{#
    <?php if (Filesystem::getMaximumFilesize() != INFINITY): ?>
    <p class="info">
        {% trans %}Supported file size:{% endtrans %} <?php echo Filesystem::getMaximumFilesizeAsString(); ?>
    </p>
    <?php endif; ?>

    <?php foreach ($this->filetypeInfo() as $info): ?>
    <p class="info">
        <?php echo $info; ?>
    </p>
    <?php endforeach; ?>
#}
{% endblock %}
